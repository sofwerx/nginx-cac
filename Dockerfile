# Dockerfile for a sample container that runs NGINX web server and uses it to
# do SSL client verification, trusting the DoD PKI.
#
# In other words you can login to this web server and require CAC just like DoD
# websites do, but without having to go through DISA IASE. :) :) :)
#
# NGINX will set headers in this config (see default.conf) to let you extract
# the serial identifier and the subject name if you wish.

# TODO: NGINX maintains an official Docker image... is it better to start from
# that?
FROM alpine:latest

RUN apk update && apk add nginx && mkdir -p /run/nginx /www/data
RUN apk add bash && apk add mariadb && apk add php

# Provided in this Docker package, and relatively simple configs
COPY default.conf /etc/nginx/conf.d/default.conf

COPY ./www /www

# Self-signed certificates generated by the Makefile.

# server cert
COPY localhost-certificate.pem /etc/nginx

# server privkey
COPY localhost-key.pem         /etc/nginx

# The Makefile will generate DoDRoots.crt (which is just DoD Root CA {2,3,4}
# concatenated) by downloading the certs from the DISA IASE website.  NGINX
# needs these certs to setup the CA it trusts for client authentication.
#
# This works only if the client supplies the intermediate certs so that the
# server can complete the complete chain of trust from the smartcard cert all
# the way to one of these 3 root certs.
# See also the default.conf's configuration where we permit NGINX to have
# multiple intermediate certs.
COPY DoDRoots.crt    /etc/nginx

EXPOSE 443/tcp
EXPOSE 80/tcp

ENTRYPOINT ["/usr/sbin/nginx", "-q", "-g", "daemon off;"]
